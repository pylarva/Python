{% extends 'layout/_laytask.html' %}

{% block css %}


{% endblock %}

{% block conent %}
    <ol class="breadcrumb" style="margin-bottom: 0;">
        <li><a href="/task.html">首页</a></li>
        <li class="active">虚拟机装机</li>
    </ol>

    <div style="padding: 5px 8px;">

        <!-- 添加主机确定模态对话框 -->
        <div id="add_machine" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title">新建虚机</h4>
                    </div>
                    <div class="modal-body">
                        宿主机：<a id="confirm_host"></a>
                        </br>
                        IP地址：<a id="confirm_ip"></a>
                        </br>
                        核心数：<a id="confirm_cpu_num"></a>
                        </br>
                        内存 ：<a id="confirm_memory_num"></a>
                        </br>
                        系统配置：<a id="confirm_type"></a>
                        </br>
                        <p>确认添加该虚拟机吗？</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button id="add_confirm" type="button" class="btn btn-primary">确定</button>
                    </div>
                </div>
            </div>
        </div>

        <!--新增物理机模态对话框-->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">新装物理主机</h4>
              </div>
              <form id="form1">
              <div class="modal-body">
                  <div class="form-group">
                    <label for="recipient-name" class="control-label">1.主机名</label>
                    <input type="text" class="form-control" id="recipient-name1">
                  </div>
                  <div class="form-group">
                    <label for="recipient-name" class="control-label">2.IP</label>
                    <input type="text" class="form-control" id="recipient-name2">
                  </div>
                  <div class="form-group">
                    <label for="recipient-name" class="control-label">3.掩码</label>
                    <input type="text" class="form-control" id="recipient-name2">
                  </div>

                  <div class="form-group">
                    <label for="recipient-name" class="control-label">4.mac地址</label>
                    <input type="text" class="form-control" id="recipient-name5">
                  </div>

                  <div class="form-group">
                    <label for="recipient-name" class="control-label">5.系统版本</label>
                    <input type="text" class="form-control" id="recipient-name5">
                  </div>

                  <div class="form-group" style="display: none">
                    <label for="recipient-name" class="control-label">5.安装时间</label>
                    <input type="text" class="form-control" id="recipient-name8">
                  </div>
              </div>
              <div class="modal-footer">
                  <span id="error_message" style="color: red;"></span>
                  <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                  <button id="save" type="button" class="btn btn-primary">新增</button>
              </div>
            </form>
            </div>
          </div>
        </div>

        <div id="connect_info" class="alert alert-info" role="alert" style="margin-bottom: 15px;">
            <button class="close" type="button" data-dismiss="alert">&times;</button>
            确认宿主机开启 镜像模版文件存放在/opt/mv/目录！</div>

        <div id="connect_failed" class="alert alert-danger alert-dismissable" role="alert">
            <button class="close" type="button" data-dismiss="alert">&times;</button>
            宿主机连接失败！请确认已在目标宿主机增加SSH_key公钥验证...
        </div>

        <div class="form-group" style="display: inline-block; width: 233px">
            <select class="selectpicker" id="recipient-name3">
                  {% for item in host_list %}
                      <option value={{ item.host_machines_ip }}>{{ item.host_machines_ip }}</option>
                  {% endfor %}
            </select>
        </div>

{#        <div class="form-group" style="width: 150px; display: inline-block">#}
{#            <input id="host_name" type="email" class="form-control" placeholder="主机名">#}
{#        </div>#}

        <div class="form-group" style="display: inline-block;">
            <select class="selectpicker" id="recipient-name4">
                  {% for item in machine_type %}
                      <option id="recipient-name4" value={{ item.id }}>{{ item.machine_type }}</option>
                  {% endfor %}
            </select>
        </div>

        </br>

        <div class="form-group" style="width: 150px; display: inline-block">
            <input id="host_ip" type="email" class="form-control" placeholder="IP地址">
        </div>

        <div class="form-group" style="width: 150px; display: inline-block">
            <input id="host_cpu" type="email" class="form-control" placeholder="CPU核心数">
        </div>

        <div class="form-group" style="width: 150px; display: inline-block">
            <input id="host_memory" type="email" class="form-control" placeholder="内存／G">
        </div>

        <button id="virtual_add" type="button" class="btn btn-primary" onclick="add_host()">新增虚机</button>


        <table class="table table-bordered" id="table">
                <tr>
                    <td>序号</td>
                    <td>IP</td>
                    <td>主机名</td>
                    <td>CPU核心</td>
                    <td>内存</td>
                    <td>配置</td>
                    <td>宿主机</td>
                    <td>业务</td>
                    <td>状态</td>
                    <td>备注</td>
                    <td>时间</td>
                </tr>
            {% for item in data %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ item.host_ip }}</td>
                    <td>{{ item.host_name }}</td>
                    <td>{{ item.cpu_num }}核</td>
                    <td>{{ item.memory_num }}G</td>
                    <td>{{ item.machine_type.machine_type }}</td>
                    <td>{{ item.mudroom_host }}</td>
                    <td>{{ item.bussiness }}</td>
                    <td>
                        <div class="progress progress-striped" style="margin-bottom: 0px";>
	                        <div class="progress-bar progress-bar-success"  role="progressbar" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100" style="width:100%">100%</div>
                        </div>
                    </td>
                    <td>详细...</td>
                    <td>{{ item.ctime|date:"Y-m-d H:i:s" }}</td>
                </tr>
            {% endfor %}

        </table>

    </div>
{% endblock %}

{% block js %}
    <script type="text/javascript" src="/static/js/jquery.cookie.js"></script>
    <script type="text/javascript" src="/static/plugins/bootstrap/js/bootstrap.js"></script>
    <script type="text/javascript" src="/static/js/nb-list.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap-select.js"></script>

    <script>

        $(function () {
            $('#connect_success').hide();
            $('#connect_failed').hide();
            $('#new_tr').hide();
            var v = $.cookie('mess');
            if (v==200){
                $('#connect_info').removeClass('alert-info');
                $('#connect_info').addClass('alert-success');
                $('#connect_info').addClass('alert-dismissable');
                $('#connect_info').text('虚机部署任务发布成功！');

                $("table tr:last td:eq(8)").children().children().attr('id', 'progress_show');
                setTimeout(function () {
                    var op = 0;
                    var tag = document.getElementById('progress_show');
                    tag.innerText='0';
                    var interval = setInterval(function () {
                        op += 1;
                        var a = op + '%';
                        tag.innerText = a;
                        document.getElementById('progress_show').style.width = a;
                        if(op>100){
                            clearInterval(interval);
                            tag.innerText = '100%';
                        }
                    }, 500);
                }, 500);

            }

            $.initMenu('#menu_asset');
            $.nbDataList('/assets.html');

            $('#add_confirm').click(function (){

                $.ajax({
                    url: 'task_virtual.html',
                    type: 'POST',
                    data: {
                        'host_machine': $('#recipient-name3').val(),
                        'new_host_ip': $('#host_ip').val(), 'machine_type': $('#recipient-name4').val(),
                        'cpu_num': $('#host_cpu').val(), 'memory_num': $('#host_memory').val()
                    },
                    dataType: 'JSON',
                    success: function (data_dict) {
                        if (data_dict.status) {
                            $('#connect_success').show();
                            $('#connect_failed').hide();
                            location.reload();
                        }else {
                            $('#connect_info').hide();
                            $('#connect_failed').show();
                            $('#message_info').text(data_dict.message);

                        }
                    }
                });
            });
        });


        function add_host() {
            if($('#host_ip').val().length<1){
                $('#connect_info').removeClass('alert-info');
                $('#connect_info').addClass('alert-danger');
                $('#connect_info').addClass('alert-dismissable');
                $('#connect_info').text('虚拟机IP不能为空！');
                return false;
            }

            var ip = $('#host_ip').val()
            var reg =  /^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/
            if(reg.test(ip)==false){
                $('#connect_info').removeClass('alert-info');
                $('#connect_info').addClass('alert-danger');
                $('#connect_info').addClass('alert-dismissable');
                $('#connect_info').text('IP地址格式错误！');
                return false;
            }

            if($('#host_cpu').val().length<1){
                $('#connect_info').removeClass('alert-info');
                $('#connect_info').addClass('alert-danger');
                $('#connect_info').addClass('alert-dismissable');
                $('#connect_info').text('核心数不能为空！');
                return false;
            }

            var cpu = $('#host_cpu').val();
            var cpu_reg = /^[0-9]*[1-9][0-9]*$/;
            if(cpu_reg.test(cpu)==false){
                $('#connect_info').removeClass('alert-info');
                $('#connect_info').addClass('alert-danger');
                $('#connect_info').addClass('alert-dismissable');
                $('#connect_info').text('核心数只能为正整数！');
                return false;
            }else if(cpu>24){
                $('#connect_info').removeClass('alert-info');
                $('#connect_info').addClass('alert-danger');
                $('#connect_info').addClass('alert-dismissable');
                $('#connect_info').text('核心数不能大于24！');
            }

            var memory = $('#host_memory').val();
            var memory_reg = /^[0-9]*[1-9][0-9]*$/;
            if(memory_reg.test(memory)==false){
                $('#connect_info').removeClass('alert-info');
                $('#connect_info').addClass('alert-danger');
                $('#connect_info').addClass('alert-dismissable');
                $('#connect_info').text('内存数请填正整数！');
                return false;
            }else if(memory>128){
                $('#connect_info').removeClass('alert-info');
                $('#connect_info').addClass('alert-danger');
                $('#connect_info').addClass('alert-dismissable');
                $('#connect_info').text('内存容量不能大于128！');
            }


            $('#confirm_host').text($('#recipient-name3').val());
            $('#confirm_cpu_num').text($('#host_cpu').val());
            $('#confirm_ip').text($('#host_ip').val());
            $('#confirm_memory_num').text($('#host_memory').val());
            if($('#recipient-name4').val()==1){
                $('#confirm_type').text('CentOS_6.4_20G');
            }
            if($('#recipient-name4').val()==2){
                $('#confirm_type').text('CentOS_6.4_100G');
            }
            if($('#recipient-name4').val()==3){
                $('#confirm_type').text('CentOS_6.4_300G');
            }
            if($('#recipient-name4').val()==4){
                $('#confirm_type').text('CentOS_7.2_20G');
            }
            if($('#recipient-name4').val()==5){
                $('#confirm_type').text('CentOS_7.2_100G');
            }
            if($('#recipient-name4').val()==6){
                $('#confirm_type').text('CentOS_7.2_300G');
            }

            $('#add_machine').modal();
        }

    </script>
{% endblock %}