{% extends 'layout/_laytask.html' %}

{% block css %}


{% endblock %}

{% block conent %}
    <ol class="breadcrumb" style="margin-bottom: 0;">
        <li><a href="/task.html">首页</a></li>
        <li class="active">虚拟机装机</li>
    </ol>

    <div style="padding: 5px 8px;">

        <!--新增物理机模态对话框-->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">新装物理主机</h4>
              </div>
              <form id="form1">
              <div class="modal-body">
                  <div class="form-group">
                    <label for="recipient-name" class="control-label">1.主机名</label>
                    <input type="text" class="form-control" id="recipient-name1">
                  </div>
                  <div class="form-group">
                    <label for="recipient-name" class="control-label">2.IP</label>
                    <input type="text" class="form-control" id="recipient-name2">
                  </div>
                  <div class="form-group">
                    <label for="recipient-name" class="control-label">3.掩码</label>
                    <input type="text" class="form-control" id="recipient-name2">
                  </div>

                  <div class="form-group">
                    <label for="recipient-name" class="control-label">4.mac地址</label>
                    <input type="text" class="form-control" id="recipient-name5">
                  </div>

                  <div class="form-group">
                    <label for="recipient-name" class="control-label">5.系统版本</label>
                    <input type="text" class="form-control" id="recipient-name5">
                  </div>

                  <div class="form-group" style="display: none">
                    <label for="recipient-name" class="control-label">5.安装时间</label>
                    <input type="text" class="form-control" id="recipient-name8">
                  </div>
              </div>
              <div class="modal-footer">
                  <span id="error_message" style="color: red;"></span>
                  <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                  <button id="save" type="button" class="btn btn-primary">新增</button>
              </div>
            </form>
            </div>
          </div>
        </div>

        <div class="alert alert-info" role="alert" style="margin-bottom: 15px;">
            <button class="close" type="button" data-dismiss="alert">&times;</button>
            确认宿主机连接成功，才能进行虚拟机的安装！</div>
        <div id="connect_success" class="alert alert-success alert-dismissable" role="alert">
            <button class="close" type="button" data-dismiss="alert">&times;</button>
            连接成功！
        </div>
        <div id="connect_failed" class="alert alert-danger alert-dismissable" role="alert">
            <button class="close" type="button" data-dismiss="alert">&times;</button>
            宿主机连接失败！请确认已在目标宿主机增加SSH_key公钥验证...
        </div>

{#        <button type="button" class="btn btn-primary" onclick="CheckAll('#edit_mode', '#tb')">全选</button>#}
{#        <button type="button" class="btn btn-success" onclick="CancleAll('#edit_mode', '#tb')">取消</button>#}
{#        <button type="button" class="btn btn-info" onclick="ReverseAll('#edit_mode', '#tb')">反选</button>#}
{#        <div class="form-group" style="width: 150px; display: inline-block">#}
{#            <input id="host_machine" type="email" class="form-control" placeholder="宿主机IP地址">#}
{#        </div>#}
        <div class="form-group" style="display: inline-block;">
            <select class="selectpicker" id="recipient-name3">
                  {% for item in host_list %}
                      <option id="recipient-name3" value={{ item.host_machines_ip }}>{{ item.host_machines_ip }}</option>
                  {% endfor %}
            </select>
        </div>

        <button id="connect_host" type="button" class="btn btn-success display: inline-block">宿主机测试</button>
        <div class="form-group" style="width: 150px; display: inline-block">
            <input id="host_name" type="email" class="form-control" placeholder="主机名">
        </div>
        <div class="form-group" style="width: 150px; display: inline-block">
            <input id="host_ip" type="email" class="form-control" placeholder="IP地址">
        </div>

        <div class="form-group" style="display: inline-block;">
            <select class="selectpicker" id="recipient-name4">
                      <option id="recipient-name4" value='4核 8G 300G'>4核 8G 300G</option>
                      <option id="recipient-name4" value='8核 16G 600G'>8核 16G 600G</option>
            </select>
        </div>


        <button id="virtual_add" type="button" class="btn btn-primary">新增虚机</button>

        <table class="table table-bordered" id="table">
                <tr>
                    <td>序号</td>
                    <td>宿主机</td>
                    <td>主机</td>
                    <td>IP</td>
                    <td>配置</td>
                    <td>业务</td>
                    <td>状态</td>
                    <td>备注</td>
                    <td>时间</td>
                </tr>
            {% for item in data %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ item.host_name }}</td>
                    <td>{{ item.host_name }}</td>
                    <td>{{ item.host_ip }}</td>
                    <td>4核 8G 300G</td>
                    <td>kvm-test</td>
                    <td>
                        <div class="progress progress-striped" style="margin-bottom: 0px";>
	                        <div class="progress-bar progress-bar-success"  role="progressbar" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100" style="width:100%">100%</div>
                        </div>
                    </td>
                    <td>详细...</td>
                    <td>{{ item.ctime }}</td>
                </tr>
            {% endfor %}

                <tr id="new_tr">
                    <td>*</td>
                    <td id="new_machine"></td>
                    <td id="new_name"></td>
                    <td id="new_ip"></td>
                    <td>4核 8G 300G</td>
                    <td>kvm-test</td>
                    <td>
                        <div class="progress progress-striped" style="margin-bottom: 0px";>
	                        <div id="progress_show" class="progress-bar progress-bar-success"  role="progressbar" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100" style="width:100%">100%</div>
                        </div>
                    </td>
                    <td>详细...</td>
                    <td></td>
                </tr>
        </table>

    </div>
{% endblock %}

{% block js %}
    <script type="text/javascript" src="/static/js/jquery.cookie.js"></script>
    <script type="text/javascript" src="/static/plugins/bootstrap/js/bootstrap.js"></script>
    <script type="text/javascript" src="/static/js/nb-list.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap-select.js"></script>

    <script>

        $(function () {
            $('#connect_success').hide();
            $('#connect_failed').hide();
            $('#new_tr').hide();

            $.initMenu('#menu_asset');
            $.nbDataList('/assets.html');
            $('#connect_host').click(function () {
                $('#connect_success').hide();
                $('#connect_failed').hide();
                $.ajax({
                    url: 'task_virtual.html',
                    type: 'post',
                    data: {
                        'host_name': $('#recipient-name3').val(),
                    },
                    dataType: 'JSON',
                    success: function (data_dict) {
                        if (data_dict.status) {
                            $('#connect_success').show();
{#                            $('#connect_success').removeAttr('style');#}
                        }else {
                            $('#connect_failed').show();
{#                            $('#connect_failed').removeAttr('style');#}
                        }
                    }
                });
            });

            $('#virtual_add').click(function (){
{#                $('#new_tr').show();#}
{#                var t=$("table tr:last td:eq(6)").children().children().text();#}
{#                alert(t);#}

                $("table tr:last td:eq(6)").children().children().attr('id', 'progress_show');


{#                var table = document.getElementsByTagName('table')[0];#}
{#                alert(table.children[0].innerHTML);#}

                $.ajax({
                    url: 'task_virtual.html',
                    type: 'POST',
                    data: {
                        'host_machine': $('#recipient-name3').val(), 'new_host_name' : $('#host_name').val(),
                        'new_host_ip': $('#host_ip').val(), 'machine_type': $('#recipient-name4').val()
                    },
                    dataType: 'JSON',
                    success: function (data_dict) {
                        if (data_dict.status) {
                            $('#connect_failed').hide();
                            $('#connect_success').show();
                            location.reload();
                        }else {
                            $('#connect_failed').show();
                            $('#connect_success').hide();
                        }
                    }
                });

                // 进度条定时器
                setTimeout(function () {
                    var op = 0;
                    var tag = document.getElementById('progress_show');
                    tag.innerText='0';
                    var interval = setInterval(function () {
                        op += 1;
                        var a = op + '%';
                        tag.innerText = a;
                        document.getElementById('progress_show').style.width = a;
                        if(op>100){
                            clearInterval(interval);
                            tag.innerText = '100%';
                        }
                    }, 500);
                }, 5000);
{#                var op = 0;#}
{#                var tag = document.getElementById('progress_show');#}
{#                tag.innerText='0';#}
{#                var interval = setInterval(function () {#}
{#                    op += 1;#}
{#                    var a = op + '%';#}
{#                    tag.innerText = a;#}
{#                    document.getElementById('progress_show').style.width = a;#}
{#                    if(op>100){#}
{#                        clearInterval(interval);#}
{#                        tag.innerText = '100%';#}
{#                    }#}
{#                }, 500);#}

            });


        });



    </script>
{% endblock %}