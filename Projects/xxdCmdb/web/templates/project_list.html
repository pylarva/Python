{% extends 'layout/_layread.html' %}

{% block css %}
    <link rel="stylesheet" href="/static/css/bootstrap-select.css">
{% endblock %}

{% block conent %}
    <ol class="breadcrumb" style="margin-bottom: 0;">
        <li><a href="/cmdb.html">首页</a></li>
        <li class="active">用户组管理</li>
    </ol>
    <div style="padding: 5px 8px;">

        <div class="list-block">
            <div class="clearfix search-area">

                <div class="col-md-offset-10 do-submit">
                    <a id="search_condition_submit" class="btn btn-primary no-radius">
                        <i class="fa fa-search"></i> 搜索
                    </a>
                </div>

                <div id="search_conditions" class="col-md-offset-2 col-md-8">
                    <div class="condition">
                        <div class="icons">
                            <a class="btn btn-default no-radius" onclick="$.AddSearchCondition(this)"><i
                                    class="fa fa-plus-square"></i></a>
                        </div>
                        <div class="inputs">
                            <div class="input-group">
                                <div id="search_condition" init="false" class="input-group-btn">
                                    <label type="button" class="btn btn-default no-radius" style="width: 100px;">&nbsp;</label>
                                    <button type="button" class="btn btn-default dropdown-toggle no-border-r" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span></button>
                                    <ul class="change-search-condition dropdown-menu">

                                    </ul>
                                </div>


                            </div>

                        </div>
                    </div>
                </div>

            </div>

{#            <div class="clearfix function-area">#}
{#                <div class="btn-group btn-group-sm custom-btn-group">#}
{#                    <a id="check_all" class="btn btn-default no-radius"><i#}
{#                            class="fa fa-check-square"></i> 全选</a>#}
{#                    <a id="check_cancel" class="btn btn-default no-radius"><i class="fa fa-minus-square-o"></i> 取消</a>#}
{#                    <a id="check_reverse" class="btn btn-default no-radius"><i#}
{#                            class="fa fa-check-square-o"></i> 反选</a>#}
{#                    <a class="btn btn-default no-radius" href="#"><i class="fa fa-plus-circle"></i>添加</a>#}
{#                    <a id="do_delete" class="btn btn-default no-radius"><i class="fa fa-trash"></i> 删除</a>#}
{#                    <a id="edit_mode_target" class="btn btn-default no-radius"><i class="fa fa-pencil-square-o"></i>#}
{#                        <span>进入编辑模式</span></a>#}
{#                    <a id="do_save" class="btn btn-default no-radius"><i class="fa fa-floppy-o"></i> 保存</a>#}
{#                    <a id="do_refresh" class="btn btn-default no-radius"><i class="fa fa-refresh"></i> 刷新</a>#}
{#                    <a id="handle_status" class="btn no-radius" tabindex="0" role="button" data-toggle="manual"#}
{#                       data-trigger="focus" data-container="body" data-html="true" data-placement="bottom" title="错误详细"#}
{#                       data-content=""></a>#}
{#                </div>#}
{#            </div>#}

            <div class="table-responsive table-area">
                <table class="table table-striped table-bordered">
                    <!-- 表格标题开始 -->
                    <thead id="table_head">
                    <tr>

                    </tr>
                    </thead>
                    <!-- 表格标题结束 -->

                    <!-- 表格内容开始 -->
                    <tbody id="table_body" edit-mode='false'>

                    </tbody>
                    <!-- 表格内容结束 -->

                </table>

{#                <table class="table table-striped table-bordered">#}
{#                    <thead id="table_head">#}
{#                    <tr>#}
{#                        <th>序号</th>#}
{#                        <th>项目名称</th>#}
{#                        <th>环境</th>#}
{#                        <th>业务线</th>#}
{#                        <th>最新发布时间</th>#}
{#                        <th>发布ID</th>#}
{#                        <th style="width: 62px;">状态</th>#}
{#                        <th>操作</th>#}
{#                    </tr>#}
{#                    </thead>#}
{#                <thead id="table_bodys">#}
{#                {% for obj in data_list %}#}
{#                    <tr>#}
{#                        <th>{{ forloop.counter }}</th>#}
{#                        <td>{{ obj.project_name }}</td>#}
{#                        <td>{{ obj.business_1 }}</td>#}
{#                        <td>{{ obj.business_2 }}</td>#}
{#                        <td>{{ obj.ctime|date:"Y-m-d H:i:s" }}</td>#}
{#                        <td>{{ obj.release_id }}</td>#}
{#                        <td style="width: 100px" >{{ obj.get_status_display }}</td>#}
{#                        <td style="width: 200px; font-size: 13px; line-height: 25px;">#}
{#                            <i class="fa fa-edge" aria-hidden="true"></i>#}
{#                            <a href="#" onclick="edit_group(this, {{ obj.id }})">上线</a> |#}
{#                            <i class="fa fa-reply-all" aria-hidden="true"></i>#}
{#                            <a href="#" onclick="del_group({{ obj.id }})">回滚</a>#}
{#                        </td>#}
{#                    </tr>#}
{#                {% endfor %}#}
{#                </thead>#}
{##}
{#                </table>#}

                <div class="clearfix">
                    <div class="right">
                        <ul id="pager" class="pagination pagination-sm no-margin">
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- 编辑应用 模态对话框 -->
    <div class="modal fade" id="edit_example" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="exampleModalLabel">编辑权限</h4>
          </div>
          <form id="form1">
          <div class="modal-body">
              <div class="form-group">
                <label for="recipient-name" class="control-label">用户组</label>
                <input type="text" class="form-control" id="ap_name">
              </div>
              <div class="form-group">
                <label for="recipient-name" class="control-label">选择环境</label>
                <br>
                  <select id="business_1" class="selectpicker" multiple>
                      {% for item in business_one_list %}
                      <option id="recipient-name23" value={{ item.id }}>{{ item.name }}</option>
                      {% endfor %}
                  </select>
              </div>
              <div class="form-group">
                <label for="recipient-name" class="control-label">选择业务线2</label>
                <br>
                  <select id="business_2" class="selectpicker" multiple>
                      {% for item in business_two_list %}
                      <option id="recipient-name23" value={{ item.id }}>{{ item.name }}</option>
                      {% endfor %}
                  </select>
              </div>
              <div class="form-group">
                <label for="recipient-name" class="control-label">选择业务线3</label>
                <br>
                  <select id="business_3" class="selectpicker" multiple>
                      {% for item in business_three_list %}
                      <option id="recipient-name23" value={{ item.id }}>{{ item.name }}</option>
                      {% endfor %}
                  </select>
              </div>
          </div>
          <div class="modal-footer">
              <span id="add_error_02" style="color: red;"></span>
              <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
              <button id="save_edit" type="button" class="btn btn-primary">保存</button>
          </div>
        </form>
        </div>
      </div>
    </div>

    <!-- 添加用户组开始 -->
    <div class="modal fade" id="add_g" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content" style="border-radius: 5px">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">添加用户组</h4>
              </div>
              <form id="form1">
              <div class="modal-body">
                  <div class="form-group">
                    <label for="recipient-name" class="control-label">1.用户组名称</label>
                    <input type="text" class="form-control" id="group_name">
                  </div>
              </div>
              <div class="modal-footer">
                  <span id="error_message" style="color: red;"></span>
                  <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                  <button id="add_groups" type="button" class="btn btn-primary">保存</button>
              </div>
            </form>
            </div>
          </div>
        </div>
    <!-- 添加用户组结束 -->

    <!-- 删除层开始 -->
    <div id="modal_delete" class="alert alert-danger alert-dismissible fade in modal-delete hide" role="alert">
        <button type="button" class="close" aria-label="Close" onclick="$.Hide('#shade,#modal_delete');"><span>×</span>
        </button>
        <h4>确定删除该用户组吗？</h4>

        <p style="text-align: right">
            <button type="button" class="btn btn-danger" id="do_delete_group">确定删除</button>
            <button type="button" class="btn btn-default" onclick="$.Hide('#shade,#modal_delete');">取消</button>
        </p>
    </div>
    <!-- 删除层结束 -->

    <!-- 遮罩层开始 -->
    <div id='shade' class='shade hide'></div>
    <!-- 遮罩层结束 -->

    <!-- 加载层开始 -->
    <div id='loading' class='loading hide'></div>
    <!-- 加载层结束 -->

{% endblock %}

{% block js %}
    <script type="text/javascript" src="/static/js/jquery.cookie.js"></script>
    <script type="text/javascript" src="/static/plugins/bootstrap/js/bootstrap.js"></script>
    <script type="text/javascript" src="/static/js/nb-list.js"></script>
    <script src="/static/js/bootstrap-select.js"></script>


    <script>
        $(function () {
            $.initMenu('#menu_list');
            $.nbDataList('/projects_list.html');
            $('#table_body').attr('edit-mode', 'true');

{#            setTimeout("do_aaa()", 100);#}

        });

        function do_aaa() {
            $('#table_bodys').children().each(function () {
                var v = $(this).children().next().next().next().next().next().next().html();
                if(v == "新提交"){
                    $(this).children().next().next().next().next().next().next().attr('style', 'display: inline-block; padding: 3px; background-color: rgb(240,173,87); margin-top:4px; margin-left:6px; margin-right:-20px');
                    $(this).children().next().next().next().next().next().next().next().attr('style', '')
                }else if(v == "[已通过]"){
                    $(this).children().next().next().next().next().next().next().attr('style', 'display: inline-block; padding: 3px;background-color: rgb(92,184,92); margin-top:4px; margin-left:6px; margin-right:-20px');
                    $(this).children().next().next().next().next().next().next().next().attr('style', '')
                }else if(v == "[已拒绝]"){
                    $(this).children().next().next().next().next().next().next().attr('style', 'display: inline-block; padding: 3px; background-color: rgb(217,83,79); margin-top:4px; margin-left:6px; margin-right:-20px');
                    $(this).children().next().next().next().next().next().next().next().attr('style', '')
                }else {
                }
            });
        }

        function edit_group(ths, nid) {
            $('#edit_example').modal();

            <!-- 获取原环境列表 -->
            var business_one_list = [];
            var business_two_list = [];
            var business_three_list = [];
            $(ths).parent().prev().prev().prev().children().each(function () {
                var v = $(this).attr('hid');
                business_one_list.push(v);
            });
            $('#business_1').selectpicker('val', business_one_list);
            var group_name = $(ths).parents().prev().prev().prev().prev().text();
            $('#ap_name').val(group_name);
            $(ths).parent().prev().prev().children().each(function () {
                var v = $(this).attr('hid');
                business_two_list.push(v);
            });
            $('#business_2').selectpicker('val', business_two_list);
            $(ths).parent().prev().children().each(function () {
                var v = $(this).attr('hid');
                business_three_list.push(v);
            });
            $('#business_3').selectpicker('val', business_three_list);

            $('#save_edit').click(function () {
                $.ajax({
                    url : '/groups.html',
                    type: 'POST',
                    dataType: 'JSON',
                    traditional: true,
                    data: {'group_name': $('#ap_name').val(), 'nid': nid, 'business_1_list': $('#business_1').selectpicker('val')
                    , 'business_2_list': $('#business_2').selectpicker('val'), 'business_3_list': $('#business_3').selectpicker('val')},
                    success: function (data_dict) {
                        if(data_dict.status){
                            location.reload();
                        }else {
                            $('#add_error_02').text(data_dict.message)
                        }
                    }
                })
            })
        }
        function add_group() {
            $('#add_g').modal();
            $('#add_groups').click(function () {
                $.ajax({
                    url : '/groups.html',
                    type: 'POST',
                    dataType: 'JSON',
                    traditional: true,
                    data: {'new_group_name': $('#group_name').val()},
                    success: function (data_dict) {
                        if(data_dict.status){
                            location.reload();
                        }else {
                            $('#add_error_02').text(data_dict.message)
                        }
                    }
                })
            })
        }
        function del_group(nid) {
            $.Show('#shade,#modal_delete');
            $('#do_delete_group').click(function () {
                $.ajax({
                    url : '/groups.html',
                    type: 'POST',
                    dataType: 'JSON',
                    traditional: true,
                    data: {'del_group_id': nid},
                    success: function (data_dict) {
                        if(data_dict.status){
                            location.reload();
                        }else {
                            $('#add_error_02').text(data_dict.message)
                        }
                    }
                })
            })
        }
    </script>
{% endblock %}